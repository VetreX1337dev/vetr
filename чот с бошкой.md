local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local TextService = game:GetService("TextService")

local player = Players.LocalPlayer
local hatPart = nil
local hatWeld = nil
local isRainbow = false
local rainbowSpeed = 0.8
local hatEnabled = true
local selectedColor = Color3.fromRGB(0, 255, 255) -- Начальный цвет голубой

if player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("HatControlGUI") then
    player.PlayerGui:FindFirstChild("HatControlGUI"):Destroy()
end

-- Создание GUI с текстом при активации
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "HatControlGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Текст при активации
local ActivationText = Instance.new("TextLabel")
ActivationText.Name = "ActivationText"
ActivationText.Size = UDim2.new(1, 0, 1, 0)
ActivationText.Position = UDim2.new(0, 0, 0, 0)
ActivationText.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
ActivationText.BackgroundTransparency = 0.3
ActivationText.Text = "by vomagla\n\nhttps://t.me/vomagla"
ActivationText.TextColor3 = Color3.fromRGB(255, 255, 255)
ActivationText.TextSize = 36
ActivationText.Font = Enum.Font.GothamBold
ActivationText.TextStrokeTransparency = 0.5
ActivationText.TextStrokeColor3 = Color3.fromRGB(0, 200, 255)
ActivationText.ZIndex = 100
ActivationText.Visible = true

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = ActivationText

ActivationText.Parent = ScreenGui

-- Задержка и скрытие текста
spawn(function()
    wait(2) -- Ждем 2 секунды
    TweenService:Create(ActivationText, TweenInfo.new(0.5), {
        BackgroundTransparency = 1,
        TextTransparency = 1,
        TextStrokeTransparency = 1
    }):Play()
    wait(0.5)
    ActivationText.Visible = false
    
    -- Копирование ссылки в буфер обмена
    pcall(function()
        setclipboard("https://t.me/vomagla")
    end)
end)

ScreenGui.Parent = player:WaitForChild("PlayerGui")

local function createGlassEffect(frame)
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 15)
    UICorner.Parent = frame
    
    local UIStroke = Instance.new("UIStroke")
    UIStroke.Color = Color3.fromRGB(255, 255, 255)
    UIStroke.Thickness = 1.5
    UIStroke.Transparency = 0.7
    UIStroke.Parent = frame
    
    return frame
end

local OpenButton = Instance.new("ImageButton")
OpenButton.Name = "OpenButton"
OpenButton.Size = UDim2.new(0, 55, 0, 55)
OpenButton.Position = UDim2.new(0, 20, 0, 40)
OpenButton.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
OpenButton.BackgroundTransparency = 0.3
OpenButton.Image = "rbxassetid://11995968788"
OpenButton.ScaleType = Enum.ScaleType.Fit
OpenButton.Parent = ScreenGui

local OpenButtonGlow = Instance.new("Frame")
OpenButtonGlow.Size = UDim2.new(1.3, 0, 1.3, 0)
OpenButtonGlow.Position = UDim2.new(-0.15, 0, -0.15, 0)
OpenButtonGlow.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
OpenButtonGlow.BackgroundTransparency = 0.8
OpenButtonGlow.ZIndex = -1
OpenButtonGlow.Parent = OpenButton

createGlassEffect(OpenButton)
createGlassEffect(OpenButtonGlow)

-- ВЕРНУЛ анимацию пульсации кнопки
spawn(function()
    while true do
        TweenService:Create(OpenButtonGlow, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0.6
        }):Play()
        wait(1)
        TweenService:Create(OpenButtonGlow, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0.9
        }):Play()
        wait(1)
    end
end)

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 350, 0, 380)
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -190)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
MainFrame.BackgroundTransparency = 0.1
MainFrame.Visible = false
MainFrame.Parent = ScreenGui

createGlassEffect(MainFrame)

local TitleFrame = Instance.new("Frame")
TitleFrame.Size = UDim2.new(1, 0, 0, 50)
TitleFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
TitleFrame.BackgroundTransparency = 0.2
TitleFrame.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 15)
TitleCorner.Parent = TitleFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "✨ HAT CONTROL ✨"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 20
Title.Font = Enum.Font.GothamBold
Title.Parent = TitleFrame

local TitleGradient = Instance.new("UIGradient")
TitleGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 200, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 100, 255))
}
TitleGradient.Rotation = 90
TitleGradient.Parent = Title

local CloseButton = Instance.new("ImageButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0.5, -15)
CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
CloseButton.BackgroundTransparency = 0.3
CloseButton.Image = "rbxassetid://11995969123"
CloseButton.Parent = TitleFrame

createGlassEffect(CloseButton)

local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -30, 1, -80)
ContentFrame.Position = UDim2.new(0, 15, 0, 70)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

local ToggleSection = Instance.new("Frame")
ToggleSection.Size = UDim2.new(1, 0, 0, 80)
ToggleSection.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
ToggleSection.BackgroundTransparency = 0.3
ToggleSection.Parent = ContentFrame

createGlassEffect(ToggleSection)

local function createToggle(labelText, yPosition, defaultValue, callback)
    local ToggleContainer = Instance.new("Frame")
    ToggleContainer.Size = UDim2.new(1, -20, 0, 30)
    ToggleContainer.Position = UDim2.new(0, 10, 0, yPosition)
    ToggleContainer.BackgroundTransparency = 1
    ToggleContainer.Parent = ToggleSection
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.7, 0, 1, 0)
    Label.BackgroundTransparency = 1
    Label.Text = labelText
    Label.TextColor3 = Color3.fromRGB(220, 220, 255)
    Label.TextSize = 16
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = ToggleContainer
    
    local ToggleBackground = Instance.new("Frame")
    ToggleBackground.Size = UDim2.new(0, 50, 0, 25)
    ToggleBackground.Position = UDim2.new(1, -55, 0.5, -12.5)
    ToggleBackground.BackgroundColor3 = defaultValue and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(100, 100, 150)
    ToggleBackground.BackgroundTransparency = 0.2
    ToggleBackground.Parent = ToggleContainer
    
    local ToggleCircle = Instance.new("Frame")
    ToggleCircle.Size = UDim2.new(0, 20, 0, 20)
    ToggleCircle.Position = UDim2.new(0, defaultValue and 27 or 3, 0.5, -10)
    ToggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ToggleCircle.Parent = ToggleBackground
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Size = UDim2.new(1, 0, 1, 0)
    ToggleButton.BackgroundTransparency = 1
    ToggleButton.Text = ""
    ToggleButton.Parent = ToggleBackground
    
    createGlassEffect(ToggleBackground)
    createGlassEffect(ToggleCircle)
    
    ToggleButton.MouseButton1Click:Connect(function()
        defaultValue = not defaultValue
        callback(defaultValue)
        
        TweenService:Create(ToggleCircle, TweenInfo.new(0.2, Enum.EasingStyle.Quint), {
            Position = UDim2.new(0, defaultValue and 27 or 3, 0.5, -10)
        }):Play()
        
        TweenService:Create(ToggleBackground, TweenInfo.new(0.2), {
            BackgroundColor3 = defaultValue and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(100, 100, 150)
        }):Play()
    end)
    
    return {Background = ToggleBackground, Circle = ToggleCircle, Button = ToggleButton}
end

local ColorSection = Instance.new("Frame")
ColorSection.Size = UDim2.new(1, 0, 0, 230)
ColorSection.Position = UDim2.new(0, 0, 0, 90)
ColorSection.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
ColorSection.BackgroundTransparency = 0.3
ColorSection.Parent = ContentFrame

createGlassEffect(ColorSection)

local ColorLabel = Instance.new("TextLabel")
ColorLabel.Size = UDim2.new(1, 0, 0, 30)
ColorLabel.BackgroundTransparency = 1
ColorLabel.Text = "COLORS"
ColorLabel.TextColor3 = Color3.fromRGB(220, 220, 255)
ColorLabel.TextSize = 18
ColorLabel.Font = Enum.Font.GothamBold
ColorLabel.Parent = ColorSection

local colors = {
    Color3.fromRGB(0, 255, 255),    -- Голубой
    Color3.fromRGB(255, 0, 0),      -- Красный
    Color3.fromRGB(0, 255, 0),      -- Зеленый
    Color3.fromRGB(255, 255, 0),    -- Желтый
    Color3.fromRGB(255, 0, 255),    -- Фиолетовый
    Color3.fromRGB(0, 0, 255),      -- Синий
    Color3.fromRGB(255, 165, 0),    -- Оранжевый
    Color3.fromRGB(255, 20, 147),   -- Розовый
    Color3.fromRGB(255, 255, 255),  -- Белый
    Color3.fromRGB(128, 0, 128),    -- Пурпурный
    Color3.fromRGB(0, 0, 0)         -- Черный
}

local ColorGrid = Instance.new("Frame")
ColorGrid.Size = UDim2.new(1, -20, 1, -40)
ColorGrid.Position = UDim2.new(0, 10, 0, 40)
ColorGrid.BackgroundTransparency = 1
ColorGrid.Parent = ColorSection

local UIGridLayout = Instance.new("UIGridLayout")
UIGridLayout.CellSize = UDim2.new(0, 45, 0, 45)
UIGridLayout.CellPadding = UDim2.new(0, 8, 0, 8)
UIGridLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIGridLayout.Parent = ColorGrid

for i, color in ipairs(colors) do
    local ColorButton = Instance.new("ImageButton")
    ColorButton.Size = UDim2.new(0, 45, 0, 45)
    ColorButton.BackgroundColor3 = color
    ColorButton.Image = ""
    
    createGlassEffect(ColorButton)
    
    ColorButton.MouseEnter:Connect(function()
        TweenService:Create(ColorButton, TweenInfo.new(0.2), {
            Size = UDim2.new(0, 48, 0, 48)
        }):Play()
    end)
    
    ColorButton.MouseLeave:Connect(function()
        TweenService:Create(ColorButton, TweenInfo.new(0.2), {
            Size = UDim2.new(0, 45, 0, 45)
        }):Play()
    end)
    
    ColorButton.MouseButton1Click:Connect(function()
        if hatPart and not isRainbow then
            hatPart.Color = color
            selectedColor = color -- Сохраняем выбранный цвет
            
            -- ВЕРНУЛ анимацию нажатия на кнопки
            TweenService:Create(ColorButton, TweenInfo.new(0.2), {
                Rotation = 360,
                Size = UDim2.new(0, 42, 0, 42)
            }):Play()
            wait(0.2)
            TweenService:Create(ColorButton, TweenInfo.new(0.2), {
                Rotation = 0,
                Size = UDim2.new(0, 48, 0, 48)
            }):Play()
            wait(0.2)
            TweenService:Create(ColorButton, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 45, 0, 45)
            }):Play()
        end
    end)
    
    ColorButton.Parent = ColorGrid
end

local function createHat(character)
    if not character then return end
    
    task.wait(0.5)
    local head = character:FindFirstChild("Head")
    if not head then
        character:WaitForChild("Head")
        head = character.Head
    end
    
    if hatPart then
        hatPart:Destroy()
        hatPart = nil
    end
    
    hatPart = Instance.new("Part")
    hatPart.Name = "CrystalHat"
    hatPart.Transparency = 0.3
    hatPart.Color = selectedColor -- Используем сохраненный цвет, а не голубой
    hatPart.Material = Enum.Material.Neon
    hatPart.CanCollide = false
    hatPart.Anchored = false
    
    local mesh = Instance.new("SpecialMesh")
    mesh.MeshId = "rbxassetid://1033714"
    mesh.Scale = Vector3.new(2.4, 1.6, 2.4)
    mesh.Parent = hatPart
    
    hatWeld = Instance.new("Weld")
    hatWeld.Part0 = head
    hatWeld.Part1 = hatPart
    hatWeld.C0 = CFrame.new(0, 1.1, 0)
    hatWeld.Parent = hatPart
    
    hatPart.Parent = character
end

local function removeHat()
    if hatPart then
        hatPart:Destroy()
        hatPart = nil
    end
end

local hatToggle = createToggle("ENABLE HAT", 10, true, function(value)
    hatEnabled = value
    if value then
        if player.Character then
            createHat(player.Character)
        end
    else
        removeHat()
    end
end)

local rainbowToggle = createToggle("RAINBOW EFFECT", 45, false, function(value)
    isRainbow = value
end)

RunService.RenderStepped:Connect(function()
    if isRainbow and hatPart and hatEnabled then
        local time = tick() * rainbowSpeed
        local r = math.sin(time) * 0.5 + 0.5
        local g = math.sin(time + 2) * 0.5 + 0.5
        local b = math.sin(time + 4) * 0.5 + 0.5
        hatPart.Color = Color3.new(r, g, b)
    elseif hatPart and hatEnabled and not isRainbow then
        -- Если радуга выключена, используем выбранный цвет
        hatPart.Color = selectedColor
    end
end)

-- Drag функционал для кнопки открытия
local openButtonDragging = false
local openButtonDragStart = nil
local openButtonStartPos = nil

OpenButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        openButtonDragging = true
        openButtonDragStart = input.Position
        openButtonStartPos = OpenButton.Position
        
        -- ВЕРНУЛ анимацию нажатия на кнопку
        TweenService:Create(OpenButton, TweenInfo.new(0.1), {
            Size = UDim2.new(0, 50, 0, 50)
        }):Play()
    end
end)

OpenButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        openButtonDragging = false
        
        -- ВЕРНУЛ анимацию отпускания кнопки
        TweenService:Create(OpenButton, TweenInfo.new(0.1), {
            Size = UDim2.new(0, 55, 0, 55)
        }):Play()
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if openButtonDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - openButtonDragStart
        OpenButton.Position = UDim2.new(
            openButtonStartPos.X.Scale, 
            openButtonStartPos.X.Offset + delta.X, 
            openButtonStartPos.Y.Scale, 
            openButtonStartPos.Y.Offset + delta.Y
        )
    end
end)

OpenButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    OpenButton.Visible = false
    
    MainFrame.Size = UDim2.new(0, 10, 0, 10)
    MainFrame.Position = UDim2.new(0.5, -5, 0.5, -5)
    MainFrame.BackgroundTransparency = 1
    
    TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 350, 0, 380),
        Position = UDim2.new(0.5, -175, 0.5, -190),
        BackgroundTransparency = 0.1
    }):Play()
end)

-- Drag функционал для меню
local menuDragging = false
local menuDragStart = nil
local menuStartPos = nil

TitleFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        menuDragging = true
        menuDragStart = input.Position
        menuStartPos = MainFrame.Position
    end
end)

TitleFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        menuDragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        if openButtonDragging then
            local delta = input.Position - openButtonDragStart
            OpenButton.Position = UDim2.new(
                openButtonStartPos.X.Scale, 
                openButtonStartPos.X.Offset + delta.X, 
                openButtonStartPos.Y.Scale, 
                openButtonStartPos.Y.Offset + delta.Y
            )
        elseif menuDragging then
            local delta = input.Position - menuDragStart
            MainFrame.Position = UDim2.new(
                menuStartPos.X.Scale, 
                menuStartPos.X.Offset + delta.X, 
                menuStartPos.Y.Scale, 
                menuStartPos.Y.Offset + delta.Y
            )
        end
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    TweenService:Create(MainFrame, TweenInfo.new(0.2), {
        Size = UDim2.new(0, 10, 0, 10),
        Position = UDim2.new(0.5, -5, 0.5, -5),
        BackgroundTransparency = 1
    }):Play()
    
    wait(0.2)
    MainFrame.Visible = false
    OpenButton.Visible = true
end)

player.CharacterAdded:Connect(function(character)
    if hatEnabled then
        createHat(character)
    end
end)

if player.Character and hatEnabled then
    createHat(player.Character)
end
